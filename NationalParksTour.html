<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.0/dist/aframe-extras.min.js"></script>
    <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v4.0.1/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/aframe-border-component@0.1.3/dist/aframe-border-component.min.js"></script>   
    <script src="https://rawgit.com/Ctrl-Alt-Zen/aframe-mobile-controls/master/components/twoway-motion/twoway-motion.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>National Parks Tour</title>
    <!-- <meta name="author" content="name">
    <meta name="description" content="description here">
    <meta name="keywords" content="keywords,here"> -->
    <!-- <link rel="shortcut icon" href="favicon.ico" type="image/vnd.microsoft.icon"> -->
    <!-- <link rel="stylesheet" href="stylesheet.css" type="text/css"> -->
  </head>
  <body>
    <a-scene onload="sceneLoaded()">
      <a-assets timeout="200000">
        <img id="USTerrainAsset" src="https://nationalparktour.imfast.io/us.png" />
        <!-- <a-asset-item id="moabTerrainAsset" src="https://nationalparktour.imfast.io/moab.glb" ></a-asset-item> -->
        <a-asset-item id="yosemiteTerrainAsset" src="https://nationalparktour.imfast.io/yosemite.glb" ></a-asset-item>
        <a-asset-item id="deadHorseTerrainAsset" src="https://nationalparktour.imfast.io/deadhorse.glb" ></a-asset-item>
        <a-asset-item id="gcTerrainAsset" src="https://nationalparktour.imfast.io/grand_canyon.glb" ></a-asset-item>
        <!-- <a-asset-item id="yellowstoneTerrainAsset" src="https://nationalparktour.imfast.io/yellowstone.glb" ></a-asset-item> -->
        <a-mixin id="portal" metalness="0.2" animation="property: opacity; from: 1; to: 0.5; dur: 1000; dir: alternate; loop: true; startEvents: default; pauseEvents: enlarge; autoplay: true" animation__enlarge="property: radius; from: 5; to: 7; dur: 200; loop: false; startEvents: enlarge; pauseEvents: shrink" animation__shrink="property: radius; to: 5; dur: 200; loop: false; autoplay: false; startEvents: shrink"></a-mixin>
      </a-assets>

      <a-entity id="USTerrainContainer" position="1 -3 -14" rotation="-90 0 0" visible="true">
        <a-sphere class="collidable" mixin="portal" static-body radius="5" color="white" position="-10.675 -3.672 1.523" scale="0.2 0.2 0.2" link="deadHorseTerrainContainer"></a-sphere>
        <a-sphere class="collidable" mixin="portal" static-body radius="5" color="white" position="-20.177 -5.495 1.523" scale="0.2 0.2 0.2" link="yosemiteContainer"></a-sphere>
        <a-sphere class="collidable" mixin="portal" static-body radius="5" color="white" position="-13 -7.094 1.523" scale="0.2 0.2 0.2" link="gcContainer"></a-sphere>
        <!-- <a-sphere class="collidable" mixin="portal" static-body radius="5" color="white" position="-11.561 2.509 1.523" scale="0.2 0.2 0.2" link="yellowstoneContainer"></a-sphere> -->
        <a-image src="#USTerrainAsset" width="4288" height="2459" scale="0.02 0.02 0.02"></a-image>
        <a-plane color="#172759" position="0 0 -0.1" height="1000" width="1000" rotation="0 0 0"></a-plane>


        <a-sky color="#000000" ></a-sky>
        
      </a-entity> 
        <!-- <a-entity id="moabContainer" position="0 -3 0" rotation="0 0 0" visible="false">
          <a-sphere class="collidable" mixin="portal" radius="5" color="white" position="3.123 2 -8.987" scale="0.2 0.2 0.2" link="deadHorseTerrainContainer"></a-sphere>
          <a-entity gltf-model="#moabTerrainAsset" scale="0.0003 0.0003 0.0003"></a-entity>

          <a-sky color="#9FC5E9" ></a-sky>
        </a-entity>  -->
          <a-entity id="deadHorseTerrainContainer" position="0 -6 0"  visible="false">
            <a-entity light="type: ambient; color: #FFFFF; intensity: 0.5" position="0 8.504 0" ></a-entity>

            <a-sky color="#9FC5E9"></a-sky>
            <a-sphere class="collidable" mixin="portal" radius="5" position="-11.06 5.221 -1.138 " scale="0.15 0.15 0.15" src="https://nationalparktour.imfast.io/dead-horse%201.jpg" link="deadHorseOverlook" ></a-sphere>
            <a-sphere class="collidable" mixin="portal" radius="5" position="-0.318 4.2 -6.976" scale="0.15 0.15 0.15" src="https://nationalparktour.imfast.io/potash%201.jpg" link="potash1" ></a-sphere>
            <a-entity gltf-model="#deadHorseTerrainAsset" scale="0.01 0.01 0.01"></a-entity> 
            <a-plane color="#76422A" position="0 -0.1 0" height="1000" width="1000" rotation="-90 0 0"></a-plane>
          </a-entity>
            <a-sky id="deadHorseOverlook" class="360image" src="https://nationalparktour.imfast.io/dead-horse%201.jpg" visible="false"></a-sky>
            <a-sky id="potash1" class="360image" src="https://nationalparktour.imfast.io/potash%201.jpg" visible="false" ></a-sky>
        <a-entity id="yosemiteContainer" position="-10 -10 10" rotation="0 0 0" visible="false">
          <a-sphere class="collidable" mixin="portal" color="white" radius="5" position="26.317 3.842 -4.046" scale="0.15 0.15 0.15" src="https://nationalparktour.imfast.io/el_cap.jpg" link="elCapitan"></a-sphere>
          <a-sphere class="collidable" mixin="portal" color="white" radius="5" position="-2.982 4.781 12.013" scale="0.15 0.15 0.15" src="https://nationalparktour.imfast.io/half_dome.jpg" link="halfDome"></a-sphere>
          <a-sphere class="collidable" mixin="portal" color="white" radius="5" position="15.464 4.407 -11.092" scale="0.15 0.15 0.15" src="https://nationalparktour.imfast.io/tunnel_view.jpg" link="tunnelView"></a-sphere>
          <a-entity gltf-model="#yosemiteTerrainAsset" scale="0.001 0.001 0.001"></a-entity>
          <!-- <a-sound src="src: url(click.mp3)" autoplay="true" position="0 0 0"></a-sound> -->
          <a-sky color="#9FC5E9" ></a-sky>
          <a-plane color="#967861" position="0 -0.1 0" height="1000" width="1000" rotation="-90 0 0"></a-plane>
        </a-entity> 
          <a-sky id="elCapitan" class="360image" src="https://nationalparktour.imfast.io/el_cap.jpg" visible="false"></a-sky>
          <a-sky id="halfDome" class="360image" src="https://nationalparktour.imfast.io/half_dome.jpg" visible="false"></a-sky>
          <a-sky id="tunnelView" class="360image" src="https://nationalparktour.imfast.io/tunnel_view.jpg" visible="false"></a-sky>
        <a-entity id="gcContainer" position="-13 -6 15" rotation="0 90 0" visible="false">
          <a-sphere class="collidable" mixin="portal" color="white" radius="5" position="23.916 2.7 17.832" scale="0.15 0.15 0.15" src="https://nationalparktour.imfast.io/grandview.jpg" link="grandview"></a-sphere>
          <a-sphere class="collidable" mixin="portal" color="white" radius="5" position="33.206 2.7 8.554" scale="0.15 0.15 0.15" src="https://nationalparktour.imfast.io/angels_window.jpg" link="angels_window"></a-sphere>
          <a-entity gltf-model="#gcTerrainAsset" scale="0.0007 0.0007 0.0007"></a-entity>
          <a-plane color="#ED966D" position="0 0.271 0" height="1000" width="1000" rotation="-90 0 0"></a-plane>
          <!-- <a-entity light="type: ambient; color: #FFFFF; intensity: 0.5" position="0 8.504 0" ></a-entity> -->

          <!-- <a-sound src="src: url(click.mp3)" autoplay="true" position="0 0 0"></a-sound> -->
          <a-sky color="#9FC5E9" ></a-sky>
        </a-entity>
          <a-sky id="grandview" class="360image" src="https://nationalparktour.imfast.io/grandview.jpg" visible="false"></a-sky>
          <a-sky id="angels_window" class="360image" src="https://nationalparktour.imfast.io/angels_window.jpg" visible="false"></a-sky>
        <!-- <a-entity id="yellowstoneContainer" position="0 -3 0" rotation="0 0 0" visible="false">
          <a-sphere class="collidable" mixin="portal" color="white" radius="5" position="23.916 2.7 17.832" scale="0.15 0.15 0.15" src="https://nationalparktour.imfast.io/grandview.jpg" link="grandview"></a-sphere>
          <a-sphere class="collidable" mixin="portal" color="white" radius="5" position="33.206 2.7 8.554" scale="0.15 0.15 0.15" src="https://nationalparktour.imfast.io/angels_window.jpg" link="angels_window"></a-sphere>
          <a-entity gltf-model="#yellowstoneTerrainAsset" rotation="0 90 0" scale="0.001 0.001 0.001"></a-entity>
          <a-plane color="#F69C69" position="0 -0.378 0" height="1000" width="1000" rotation="-90 0 0"></a-plane>
          <a-sky src="https://nationalparktour.imfast.io/stars.jpg"></a-sky>
        </a-entity> -->




      <a-sphere id="back" class="collidable"  mixin="portal" radius="5" color="white" position="0 50 0" scale="2 2 2" opacity="0.5" animation="enabled: false"></a-sphere>

      <a-entity id="rig" movement-controls position="0 0 0">

        <a-camera id="camera" twoway-motion="speed: 35" look-controls="pointerLockEnabled: true">
          <a-sky id="transition" color="#000000" opacity="0" radius="1" animation__fadeout="property: opacity; from: 0; to: 1; dur: 500; startEvents: fadeout" animation__fadein="property: opacity; from: 1; to: 0; dur: 500; loop: false; startEvents: fadein"></a-sky>
          <a-entity id="cursor" cursor="fuse: true; fuseTimeout: 500" position="0 0 -1" geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03" material="color: black; shader: flat" raycaster="objects: .collidable; near: 0; far: 500">
          </a-entity>
        </a-camera>

        <a-entity laser-controls="hand: left"></a-entity>
        <a-entity id="rightController" laser-controls="hand: right" raycaster="objects: .collidable; near: 0; far: 500"></a-entity>
      </a-entity>


      <a-entity light="type: ambient; color: #FFFFF; intensity: 1" position="0 8.504 0" ></a-entity>

      
    </a-scene>
  </body>
  <script>
    
    class Stack {
      constructor(){
          this.data = [];
          this.top = 0;
      }
      push(element) {
        this.data[this.top] = element;
        this.top = this.top + 1;
      }
      length() {
          return this.top;
      }
      peek() {
          return this.data[this.top-1];
      }
      isEmpty() {
        return this.top === 0;
      }
      pop() {
        if( this.isEmpty() === false ) {
          this.top = this.top -1;
          return this.data.pop(); // removes the last element
        }
      }
      print() {
          var top = this.top - 1; // because top points to index where new    element to be inserted
          while(top >= 0) { // print upto 0th index
              console.log(this.data[top]);
              top--;
          }
        }
        reverse() {
          this._reverse(this.top - 1 );
        }
        _reverse(index) {
          if(index != 0) {
              this._reverse(index-1);
          }
          console.log(this.data[index]);
        }
    }
    var scene = document.getElementsByTagName("a-scene")[0];
    var transition = document.getElementById("transition");
    var rig = document.getElementById("rig");

    var collidables = document.querySelectorAll('.collidable');
    var intersecting = null;
    var reverse = new Stack();
    var current = document.getElementById("USTerrainContainer");
    // var transitioning = false;
    
    var rightController = document.getElementById("rightController");
    var cursor = document.getElementById("cursor");

    scene.addEventListener('loaded', function () {
      console.log("sceneLoaded");
      // scene.setAttribute("fog", "type: exponential; color: #AAA; near: 1 1000; density: 0.05");
      collidables.forEach(item => {
        item.emit("default");
      });
    });

  //TODO: fix conditional to be more efficient
    function enterSelected() {
      var selected = intersecting;
      if (selected) {
        selected.setAttribute("class", "disabled");
        if (selected.id == "back" && !reverse.isEmpty()) {
          console.log("Reverse: ", reverse);
          transition.emit('fadeout');
          setTimeout(function () {
            rig.setAttribute("position", "0 0 0");
            current.setAttribute("visible", "false");
            current = reverse.pop();
            current.setAttribute("visible", "true");
            selected.emit("default");
            transition.emit('fadein');
          }, 550);
        }
        else if (selected.id == "back" && reverse.isEmpty()) {
          console.log("Nothing previous");
        }
        else {
          console.log("Forward");
          // transitioning = true;
          // intersecting.setAttribute("animation", "property: radius; to: 1000; dur: 1000; loop: false");
          transition.emit('fadeout');
          setTimeout(function () {
            rig.setAttribute("position", "0 0 0");
            current.setAttribute("visible", "false");
            reverse.push(current);
            current = document.getElementById(selected.getAttribute("link")); 
            current.setAttribute("visible", "true");
            selected.emit("default");
            transition.emit('fadein');
          }, 550);
        }
        selected.setAttribute("class", "collidable");
      }
      else {
        console.log("No item selected");
      }
    }

    rightController.addEventListener('triggerdown', function() {
      enterSelected();
    });

    cursor.addEventListener('mouseup', function() {
      enterSelected();
    });

    cursor.addEventListener('touchend', function() {
      enterSelected();
    });

    collidables.forEach(item => {
      item.addEventListener('raycaster-intersected', event => {
        if (event.target.parentElement.getAttribute("visible")){
          intersecting = event.target;
          console.log(event.target);
          intersecting.setAttribute("opacity", "1");
          intersecting.emit("enlarge");
        }
        else {
          console.log("Invisible hit");
        }
      })
    });

    collidables.forEach(item => {
      item.addEventListener('raycaster-intersected-cleared', event => { 
        if (intersecting) {
          console.log("cleared");
          intersecting.emit("shrink");
          intersecting.setAttribute("opacity", "0.5");
          intersecting.emit("default");
        }
        intersecting = null;
      })
    });




  </script>
</html>